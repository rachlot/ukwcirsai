{
    "ID": "Home",
    "layout": {
        "widget": "page",
        "children": [
            {
                "style": {
                    "maxWidth": "800px",
                    "margin": "0 auto",
                    "padding": "20px",
                    "borderRadius": "8px",
                    "boxShadow": "0 4px 12px rgba(0, 0, 0, 0.1)",
                    "backgroundColor": "#f9f9f9",
                    "fontFamily": "'Roboto', sans-serif"
                },
                "widget": "container",
                "children": [
                    {
                        "html": "<h1 style='font-size: 2.5em; font-weight: 700; color: #333;'>Vorfälle anonym berichten & helfen!</h1><p style='font-size: 1.1em; color: #555;'>Incidents, die in das CIRS (Critical Incidents Reporting System) eingetragen werden, sind <b>anonym</b> und können nicht mit der berichtenden Person in Verbindung gebracht werden.</p>",
                        "widget": "html"
                    },
                    {
                        "html": "<p style='font-size: 1.1em; color: #555;'>Durch das Teilen des Vorfalles können zukünftige Fälle verhindert werden!</p>",
                        "widget": "html"
                    },
                    {
                        "text": "Analysieren",
                        "expression": "{\n  \"bericht\": variable.bericht\n}",
                        "print": "(\n\n$x := $curl(\n  \"POST\", \n  \"https://api.openai.com/v1/chat/completions\",\n  {\n    \"model\": \"gpt-4o-mini\",\n    \"response_format\": { \"type\": \"json_object\" },\n    \"messages\": [\n      {\n        \"role\": \"system\", \n        \"content\": \"Deine Aufgabe ist es, den folgenden Bericht zu anonymisieren, die relevanten Felder zu extrahieren und in ein JSON-Objekt zu übersetzen. Nutze dazu die Informationen der Eingabe. Fehlt eine Information in der Eingabe, nutze den Wert 'unbekannt'. Ersetze alle Namen durch generische Begriffe wie 'Arzt', 'Patient' oder 'Pfleger', außer der Titel ist explizit (z.B. 'Dr.' oder 'Pfleger'). Extrahiere auch das beteiligte Medizinprodukt und frage den Benutzer nach einer passenden Zuordnung, wenn nötig. Extrahiere die folgenden Felder:\n\n- Zuständiges Fachgebiet\n- Altersgruppe des Patienten\n- Wo ist das Ereignis passiert\n- Welche Versorgungsart\n- ASA-Klassifizierung\n- Patientenzustand\n- Wichtige Begleitumstände\n- War ein Medizinprodukt beteiligt (wenn ja, nenne das Produkt)\n- Fallbeschreibung\n- Was war besonders gut\n- Was war besonders ungünstig\n- Eigener Ratschlag\n- Wie häufig tritt ein Ereignis dieser Art auf\n- Ihre Berufserfahrung\"\n      },\n      {\n        \"role\": \"user\", \n        \"content\": form.bericht\n      }\n    ]\n  },\n  { \"Authorization\": \"Bearer YOUR_OPENAI_API_KEY\" }\n);\n\ntry {\n  $xParsed := $parseJson($x);\n  \n  // Medizinprodukt-Details hinzufügen, falls vorhanden\n  if ($xParsed['War ein Medizinprodukt beteiligt'] === 'Ja') {\n    $xParsed['Medizinprodukt'] = form.Medizinprodukt;\n  }\n\n  // Nach Benutzerbegriff fragen, wenn kein Titel vorhanden\n  if (!$contains(form.bericht, ['Dr.', 'Pfleger', 'Schwester'])) {\n    $begriff := form.benutzerBegriff;\n    $xParsed['Name-Ersatz'] = $begriff;\n  }\n\n  $setVariable(\"cirs\", $xParsed);\n  $setVariable(\"anonymisierterBericht\", $xParsed);\n  $setVariable(\"bericht\", form.bericht);\n} catch (e) {\n  $log(\"Fehler bei der Verarbeitung des OpenAI-Ergebnisses: \" & e);\n}\n$refresh();\n\n)"
                    },
                    {
                        "widget": "button",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "bericht": {
                                    "widget": "textarea",
                                    "style": {
                                        "width": "1200px"
                                    },
                                    "required": false,
                                    "title": "Bericht"
                                },
                                "Medizinprodukt": {
                                    "widget": "text",
                                    "style": {
                                        "width": "600px"
                                    },
                                    "required": false,
                                    "title": "Welches Medizinprodukt war beteiligt?"
                                },
                                "benutzerBegriff": {
                                    "widget": "select",
                                    "title": "Welcher Begriff passt am besten?",
                                    "enum": ["Arzt", "Patient", "Pflegekraft", "Person"],
                                    "required": false
                                }
                            }
                        }
                    },
                    {
                        "text": "Speichern",
                        "expression": "variable.cirs",
                        "print": "$create(\"postgres\", \"Ereignis\", form)",
                        "title": "Vorschau",
                        "widget": "button",
                        "schema": {
                            "type": "object",
                            "properties": {
                                "Zuständiges Fachgebiet": {

                                },
                                "Altersgruppe des Patienten": {

                                },
                                "Wo ist das Ereignis passiert": {

                                },
                                "Welche Versorgungsart": {

                                },
                                "ASA-Klassifizierung": {

                                },
                                "Patientenzustand": {

                                },
                                "Wichtige Begleitumstände": {

                                },
                                "War ein Medizinprodukt beteiligt": {

                                },
                                "Fallbeschreibung": {

                                },
                                "Was war besonders gut": {

                                },
                                "Was war besonders ungünstig": {

                                },
                                "Eigener Ratschlag": {

                                },
                                "Wie häufig tritt ein Ereignis dieser Art auf": {

                                },
                                "Ihre Berufserfahrung": {

                                }
                            }
                        }
                    },
                    {
                        "html": "<h2 style='font-size: 1.5em; font-weight: 700; color: #333;'>Anonymisierter Bericht</h2><p style='font-size: 1.1em; color: #555;'>",
                        "widget": "html"
                    },
                    {
                        "widget": "textarea",
                        "expression": "variable.anonymisierterBericht",
                        "title": "Anonymisierter Bericht",
                        "style": {
                            "width": "1200px",
                            "height": "300px"
                        }
                    }
                ]
            }
        ]
    }
}
